- name: Platform \ Platform
  commands:
    - command: go build -v -o ./bin/platform .
      checks:
        - name: exitcode
          data:
            - "0"
- name: Platform \ Go Basic \ Discover
  commands:
    - command: ./testbed.sh gobasic discover 2>&1 | sort
      checks:
        - name: stdout
          data:
            - '  INF discover dir=gobasic builder=go/basic'
- name: Platform \ Go Basic \ Bootstrap
  commands:
    - command: ./testbed.sh gobasic bootstrap "Johnny Appleseed" "john@apple.com" "github.com/prod9/platform" "ghcr.io/prod9/platform"
      checks:
        - name: ./testbeds/gobasic/platform.toml
          data:
            - '-----BEGIN platform.toml-----'
            - maintainer = "Johnny Appleseed <john@apple.com>"
            - platform = "linux/amd64"
            - repository = "github.com/prod9/platform"
            - strategy = "timestamp"
            - excludes = ["*.docker", "*.local", ".dockerignore", ".git", ".github", ".gitignore", ".idea", ".vscode", "node_modules", "platform.toml"]
            - ""
            - '[modules]'
            - '  [modules.gobasic]'
            - '    workdir = "."'
            - '    timeout = 5000000000'
            - '    builder = "go/basic"'
            - '    publish = false'
            - '-----END platform.toml-----'
            - ""
        - name: ./testbeds/gobasic/platform
          data:
            - '-----BEGIN platform-----'
            - '#!/bin/sh'
            - ""
            - PLATFORM_VERSION="v0.2.1"
            - ""
            - go run "platform.prodigy9.co@$PLATFORM_VERSION" "$@"
            - '-----END platform-----'
            - ""
        - name: ./testbeds/gobasic/.buildkite/*.*
          data:
            - '-----BEGIN pipeline.yaml-----'
            - '# vim: filetype=yaml'
            - 'steps:'
            - '  - name: ":mountain: Prepare OS"'
            - '    command: "apk add build-base git go"'
            - '    key: os'
            - ""
            - '  # regular builds'
            - '  - name: ":wrench: Build"'
            - '    command: "./platform build"'
            - '    if: build.tag == null'
            - '    depends_on: os'
            - ""
            - '  # publish image if git tag is present'
            - '  - name: ":wrench: Build and Publish"'
            - '    command: "./platform publish"'
            - '    if: build.tag != null && build.tag =~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - ""
            - '  # deploy if environment tag is present'
            - '  - name: ":rocket: Build and Deploy"'
            - '    command: "./platform deploy --no-tag $$BUILDKITE_TAG"'
            - '    if: build.tag != null && build.tag !~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - '-----END pipeline.yaml-----'
            - ""
- name: Platform \ Go Workspace \ Discover
  commands:
    - command: ./testbed.sh gowork discover 2>&1 | sort
      checks:
        - name: stdout
          data:
            - '  INF discover dir=app builder=go/workspace'
            - '  INF discover dir=fx builder=go/workspace'
- name: Platform \ Go Workspace \ Bootstrap
  commands:
    - command: ./testbed.sh gowork bootstrap "Johnny Appleseed" "john@apple.com" "github.com/prod9/platform" "ghcr.io/prod9/platform"
      checks:
        - name: ./testbeds/gowork/platform.toml
          data:
            - '-----BEGIN platform.toml-----'
            - maintainer = "Johnny Appleseed <john@apple.com>"
            - platform = "linux/amd64"
            - repository = "github.com/prod9/platform"
            - strategy = "timestamp"
            - excludes = ["*.docker", "*.local", ".dockerignore", ".git", ".github", ".gitignore", ".idea", ".vscode", "node_modules", "platform.toml"]
            - ""
            - '[modules]'
            - '  [modules.app]'
            - '    workdir = "./app"'
            - '    timeout = 5000000000'
            - '    builder = "go/workspace"'
            - '    publish = false'
            - '  [modules.fx]'
            - '    workdir = "./fx"'
            - '    timeout = 5000000000'
            - '    builder = "go/workspace"'
            - '    publish = false'
            - '-----END platform.toml-----'
            - ""
        - name: ./testbeds/gowork/platform
          data:
            - '-----BEGIN platform-----'
            - '#!/bin/sh'
            - ""
            - PLATFORM_VERSION="v0.2.1"
            - ""
            - go run "platform.prodigy9.co@$PLATFORM_VERSION" "$@"
            - '-----END platform-----'
            - ""
        - name: ./testbeds/gowork/.buildkite/*.*
          data:
            - '-----BEGIN pipeline.yaml-----'
            - '# vim: filetype=yaml'
            - 'steps:'
            - '  - name: ":mountain: Prepare OS"'
            - '    command: "apk add build-base git go"'
            - '    key: os'
            - ""
            - '  # regular builds'
            - '  - name: ":wrench: Build"'
            - '    command: "./platform build"'
            - '    if: build.tag == null'
            - '    depends_on: os'
            - ""
            - '  # publish image if git tag is present'
            - '  - name: ":wrench: Build and Publish"'
            - '    command: "./platform publish"'
            - '    if: build.tag != null && build.tag =~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - ""
            - '  # deploy if environment tag is present'
            - '  - name: ":rocket: Build and Deploy"'
            - '    command: "./platform deploy --no-tag $$BUILDKITE_TAG"'
            - '    if: build.tag != null && build.tag !~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - '-----END pipeline.yaml-----'
            - ""
- name: Platform \ PNPM Basic \ Discover
  commands:
    - command: ./testbed.sh pnpmbasic discover 2>&1 | sort
      checks:
        - name: stdout
          data:
            - '  INF discover dir=pnpmbasic builder=pnpm/basic'
- name: Platform \ PNPM Basic \ Bootstrap
  commands:
    - command: ./testbed.sh pnpmbasic bootstrap "Johnny Appleseed" "john@apple.com" "github.com/prod9/platform" "ghcr.io/prod9/platform"
      checks:
        - name: ./testbeds/pnpmbasic/platform.toml
          data:
            - '-----BEGIN platform.toml-----'
            - maintainer = "Johnny Appleseed <john@apple.com>"
            - platform = "linux/amd64"
            - repository = "github.com/prod9/platform"
            - strategy = "timestamp"
            - excludes = ["*.docker", "*.local", ".dockerignore", ".git", ".github", ".gitignore", ".idea", ".vscode", "node_modules", "platform.toml"]
            - ""
            - '[modules]'
            - '  [modules.pnpmbasic]'
            - '    workdir = "."'
            - '    timeout = 5000000000'
            - '    builder = "pnpm/basic"'
            - '    publish = false'
            - '-----END platform.toml-----'
            - ""
        - name: ./testbeds/pnpmbasic/platform
          data:
            - '-----BEGIN platform-----'
            - '#!/bin/sh'
            - ""
            - PLATFORM_VERSION="v0.2.1"
            - ""
            - go run "platform.prodigy9.co@$PLATFORM_VERSION" "$@"
            - '-----END platform-----'
            - ""
        - name: ./testbeds/pnpmbasic/.buildkite/*.*
          data:
            - '-----BEGIN pipeline.yaml-----'
            - '# vim: filetype=yaml'
            - 'steps:'
            - '  - name: ":mountain: Prepare OS"'
            - '    command: "apk add build-base git go"'
            - '    key: os'
            - ""
            - '  # regular builds'
            - '  - name: ":wrench: Build"'
            - '    command: "./platform build"'
            - '    if: build.tag == null'
            - '    depends_on: os'
            - ""
            - '  # publish image if git tag is present'
            - '  - name: ":wrench: Build and Publish"'
            - '    command: "./platform publish"'
            - '    if: build.tag != null && build.tag =~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - ""
            - '  # deploy if environment tag is present'
            - '  - name: ":rocket: Build and Deploy"'
            - '    command: "./platform deploy --no-tag $$BUILDKITE_TAG"'
            - '    if: build.tag != null && build.tag !~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - '-----END pipeline.yaml-----'
            - ""
- name: Platform \ PNPM Workspace \ Discover
  commands:
    - command: ./testbed.sh pnpmwork discover 2>&1 | sort
      checks:
        - name: stdout
          data:
            - '  INF discover dir=storybook builder=pnpm/workspace'
            - '  INF discover dir=web builder=pnpm/workspace'
- name: Platform \ PNPM Workspace \ Bootstrap
  commands:
    - command: ./testbed.sh pnpmwork bootstrap "Johnny Appleseed" "john@apple.com" "github.com/prod9/platform" "ghcr.io/prod9/platform"
      checks:
        - name: ./testbeds/pnpmwork/platform.toml
          data:
            - '-----BEGIN platform.toml-----'
            - maintainer = "Johnny Appleseed <john@apple.com>"
            - platform = "linux/amd64"
            - repository = "github.com/prod9/platform"
            - strategy = "timestamp"
            - excludes = ["*.docker", "*.local", ".dockerignore", ".git", ".github", ".gitignore", ".idea", ".vscode", "node_modules", "platform.toml"]
            - ""
            - '[modules]'
            - '  [modules.storybook]'
            - '    workdir = "./storybook"'
            - '    timeout = 5000000000'
            - '    builder = "pnpm/workspace"'
            - '    publish = false'
            - '  [modules.web]'
            - '    workdir = "./web"'
            - '    timeout = 5000000000'
            - '    builder = "pnpm/workspace"'
            - '    publish = false'
            - '-----END platform.toml-----'
            - ""
        - name: ./testbeds/pnpmwork/platform
          data:
            - '-----BEGIN platform-----'
            - '#!/bin/sh'
            - ""
            - PLATFORM_VERSION="v0.2.1"
            - ""
            - go run "platform.prodigy9.co@$PLATFORM_VERSION" "$@"
            - '-----END platform-----'
            - ""
        - name: ./testbeds/pnpmwork/.buildkite/*.*
          data:
            - '-----BEGIN pipeline.yaml-----'
            - '# vim: filetype=yaml'
            - 'steps:'
            - '  - name: ":mountain: Prepare OS"'
            - '    command: "apk add build-base git go"'
            - '    key: os'
            - ""
            - '  # regular builds'
            - '  - name: ":wrench: Build"'
            - '    command: "./platform build"'
            - '    if: build.tag == null'
            - '    depends_on: os'
            - ""
            - '  # publish image if git tag is present'
            - '  - name: ":wrench: Build and Publish"'
            - '    command: "./platform publish"'
            - '    if: build.tag != null && build.tag =~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - ""
            - '  # deploy if environment tag is present'
            - '  - name: ":rocket: Build and Deploy"'
            - '    command: "./platform deploy --no-tag $$BUILDKITE_TAG"'
            - '    if: build.tag != null && build.tag !~ /^v[0-9]+.*/'
            - '    depends_on: os'
            - '-----END pipeline.yaml-----'
            - ""
